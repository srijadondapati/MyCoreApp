parameters:
  - name: environmentName
    type: string

jobs:
- job: Tag_Work_Items
  displayName: Tag Work Items - ${{ parameters.environmentName }}
  dependsOn: Build
  condition: succeeded()
  steps:
  - task: PowerShell@2
    displayName: Update ADO work item tags
    inputs:
      targetType: inline
      pwsh: true
      script: |

        Write-Host "Starting work item tagging for environment: ${{ parameters.environmentName }}"

        # ==========================
        # Read variables
        # ==========================
        $org     = "$(ADO_ORG)"
        $project = "$(ADO_PROJECT)"
        $pat     = "$(ADO_PAT)"
        $envName = "${{ parameters.environmentName }}"

        if (-not $org -or -not $project -or -not $pat) {
          Write-Error "Missing required ADO variables"
          exit 1
        }

        # ==========================
        # Auth header
        # ==========================
        $base64Auth = [Convert]::ToBase64String(
          [Text.Encoding]::ASCII.GetBytes(":$pat")
        )

        $authHeader = @{
          Authorization = "Basic $base64Auth"
        }

        # ==========================
        # Read commit message
        # ==========================
        $commitMessage = git log -1 --pretty=%B
        Write-Host "Commit message: $commitMessage"

        # ==========================
        # Extract AB#123 IDs
        # ==========================
        $workItemIds = [regex]::Matches($commitMessage, 'AB#(\d+)') |
                       ForEach-Object { $_.Groups[1].Value } |
                       Select-Object -Unique

        if (-not $workItemIds) {
          Write-Host "No work item IDs found. Skipping."
          exit 0
        }

        foreach ($id in $workItemIds) {

          Write-Host "Processing Work Item $id"

          $url = "https://dev.azure.com/$org/$project/_apis/wit/workitems/$id?api-version=7.1-preview.3"

          try {
            $wi = Invoke-RestMethod `
              -Method Get `
              -Uri $url `
              -Headers $authHeader
          }
          catch {
            Write-Error "Failed to fetch work item $id"
            throw
          }

          $existingTags = $wi.fields.'System.Tags'
          $newTag = "DevOpsDeployed:$envName"

          if ($existingTags -and $existingTags -like "*$newTag*") {
            Write-Host "Tag already exists for $id"
            continue
          }

          $updatedTags = if ($existingTags) {
            "$existingTags;$newTag"
          } else {
            $newTag
          }

          $patchBody = @(
            @{
              op    = "add"
              path  = "/fields/System.Tags"
              value = $updatedTags
            }
          ) | ConvertTo-Json -Depth 5

          Invoke-RestMethod `
            -Method Patch `
            -Uri $url `
            -Headers @{
              Authorization = $authHeader.Authorization
              "Content-Type" = "application/json-patch+json"
            } `
            -Body $patchBody

          Write-Host "Updated work item $id"
        }
