parameters:
- name: environmentName
  type: string

steps:
- task: PowerShell@2
  displayName: Update ADO work item tags (${{ parameters.environmentName }})
  inputs:
    targetType: inline
    pwsh: true
    script: |
      Write-Host "Starting work item tagging for environment: ${{ parameters.environmentName }}"

      # ==========================
      # Read variables
      # ==========================
      $org     = "$(ADO_ORG)".Trim()
      $pat     = "$(ADO_PAT)".Trim()
      $envName = "${{ parameters.environmentName }}".Trim()

      if (-not $org -or -not $pat) {
        Write-Error "Missing required variables. ADO_ORG or ADO_PAT is empty."
        exit 1
      }

      Write-Host "ADO_ORG = '$org'"
      Write-Host "ENV     = '$envName'"

      # ==========================
      # Auth header (PAT)
      # ==========================
      $base64Auth = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes(":$pat"))
      $headers = @{
        Authorization = "Basic $base64Auth"
        "Content-Type" = "application/json"
      }

      # ==========================
      # Read commit message
      # ==========================
      $commitMessage = git log -1 --pretty=%B
      Write-Host "Commit message: $commitMessage"

      # ==========================
      # Extract AB#123 IDs
      # ==========================
      $workItemIds = [regex]::Matches($commitMessage, 'AB#(\d+)') |
        ForEach-Object { $_.Groups[1].Value } |
        Select-Object -Unique

      if (-not $workItemIds -or $workItemIds.Count -eq 0) {
        Write-Host "No work item IDs found. Skipping."
        exit 0
      }

      # ==========================
      # Helper: call REST and show real failures
      # ==========================
      function Invoke-AdoRest {
        param(
          [Parameter(Mandatory=$true)][string]$Method,
          [Parameter(Mandatory=$true)][string]$Url,
          [Parameter(Mandatory=$false)][string]$Body
        )

        try {
          if ($Body) {
            return Invoke-RestMethod -Method $Method -Uri $Url -Headers $headers -Body $Body -ErrorAction Stop
          } else {
            return Invoke-RestMethod -Method $Method -Uri $Url -Headers $headers -ErrorAction Stop
          }
        }
        catch {
          $status = $null
          $respText = $null

          if ($_.Exception.Response) {
            try {
              $status = [int]$_.Exception.Response.StatusCode
              $stream = $_.Exception.Response.GetResponseStream()
              if ($stream) {
                $reader = New-Object System.IO.StreamReader($stream)
                $respText = $reader.ReadToEnd()
              }
            } catch { }
          }

          Write-Error "REST FAILED: $Method $Url"
          if ($status)   { Write-Error "HTTP Status: $status" }
          if ($respText) { Write-Error "Response: $respText" }
          throw
        }
      }

      # ==========================
      # (Optional) Quick auth sanity check
      # If this fails with 401/403, PAT/auth is the problem, not the work item.
      # ==========================
      $authTestUrl = "https://dev.azure.com/$org/_apis/connectiondata?api-version=7.1"
      Write-Host "Auth test: $authTestUrl"
      Invoke-AdoRest -Method Get -Url $authTestUrl | Out-Null
      Write-Host "Auth test passed."

      foreach ($id in $workItemIds) {
        Write-Host "Processing Work Item $id"

        # Org-level endpoint (no project). Avoids wrong project segment issues.
        $wiUrl = "https://dev.azure.com/$org/_apis/wit/workitems/$id?api-version=7.1"
        Write-Host "GET: $wiUrl"

        $wi = Invoke-AdoRest -Method Get -Url $wiUrl

        $existingTags = $wi.fields.'System.Tags'
        $newTag = "DevOpsDeployed:$envName"

        if ($existingTags -and $existingTags -like "*$newTag*") {
          Write-Host "Tag already exists for Work Item $id => $newTag"
          continue
        }

        $updatedTags = if ($existingTags) { "$existingTags;$newTag" } else { $newTag }

        $patchBody = @(
          @{
            op   = "add"
            path = "/fields/System.Tags"
            value = $updatedTags
          }
        ) | ConvertTo-Json -Depth 5

        Write-Host "PATCH: $wiUrl"
        Invoke-AdoRest -Method Patch -Url $wiUrl -Body $patchBody | Out-Null

        Write-Host "Updated Work Item $id with tag: $newTag"
      }
