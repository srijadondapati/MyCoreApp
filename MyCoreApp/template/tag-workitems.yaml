parameters:
- name: environmentName
  type: string
  default: 'BUILD'

jobs:
- job: Tag_Work_Items
  displayName: 'Tag work items: ${{ parameters.environmentName }}'
  pool:
    vmImage: ubuntu-latest

  steps:
  - powershell: |
      $org = "$(ADO_ORG)"
      $project = "$(ADO_PROJECT)"
      $envTag = "DevOpsDeployed:${{ parameters.environmentName }}"
      
      Write-Host "=========================================="
      Write-Host "Azure DevOps Work Item Tag Update"
      Write-Host "=========================================="
      Write-Host "Environment Tag: $envTag"
      Write-Host "Organization: $org"
      Write-Host "Project: $project"

      $pat = "$(ADO_PAT)"
      if ([string]::IsNullOrWhiteSpace($pat)) {
        throw "ADO_PAT is missing. Please check your variable group 'workitem-tagging-secrets'."
      }

      # Auth header
      $basicAuth = [Convert]::ToBase64String(
        [Text.Encoding]::ASCII.GetBytes(":$pat")
      )

      # Extract Work Item IDs from commit message
      $commitMsg = "$(Build.SourceVersionMessage)"
      Write-Host "Commit Message: $commitMsg"
      
      $ids = [regex]::Matches($commitMsg, 'AB#(\d+)') |
             ForEach-Object { $_.Groups[1].Value } |
             Select-Object -Unique

      Write-Host "Found work item IDs: $($ids -join ', ')"

      if ($ids.Count -eq 0) {
        Write-Host "No work items found. Skipping."
        exit 0
      }

      $successCount = 0
      $failureCount = 0
      
      foreach ($id in $ids) {
        Write-Host ""
        Write-Host "➡️ Processing Work Item ID: $id"
        Write-Host "----------------------------------------"
        
        try {
          # Construct URL
          $url = "https://dev.azure.com/$org/$project/_apis/wit/workitems/$($id)?api-version=7.1-preview.3"
          Write-Host "API URL: $url"
          
          # Read existing work item
          $wi = Invoke-RestMethod -Method Get -Uri $url -Headers @{
            Authorization = "Basic $basicAuth"
          }

          $wiTitle = $wi.fields.'System.Title'
          $existingTags = $wi.fields.'System.Tags'
          if (-not $existingTags) { $existingTags = "" }

          Write-Host "Title: $wiTitle"
          Write-Host "Current Tags: '$existingTags'"
          
          # Check if already has this tag
          if ($existingTags -match [regex]::Escape($envTag)) { 
            Write-Host "✅ Already tagged with: $envTag"
            $successCount++
            continue 
          }

          # METHOD 1: Try using simple "add" operation (just add the new tag)
          Write-Host "Attempting to add tag using 'add' operation..."
          
          # Create the update payload - JUST add the new tag
          $updatePayload = @(
            @{
              op = "add"
              path = "/fields/System.Tags"
              value = $envTag
            }
          )
          
          # Convert to JSON with proper depth
          $body = $updatePayload | ConvertTo-Json -Depth 3
          Write-Host "Request Body: $body"
          
          Write-Host "Sending PATCH request..."
          $response = Invoke-RestMethod -Method Patch -Uri $url -Headers @{
            Authorization  = "Basic $basicAuth"
            "Content-Type" = "application/json-patch+json"
          } -Body $body
          
          Write-Host "✅ Successfully added tag to Work Item $id"
          Write-Host "   Title: $wiTitle"
          Write-Host "   Added Tag: $envTag"
          $successCount++
          
        } catch {
          Write-Host "❌ Error updating Work Item $id"
          Write-Host "   Error Message: $($_.Exception.Message)"
          
          # Try METHOD 2: Use "replace" operation if "add" fails
          Write-Host "Trying 'replace' operation as fallback..."
          
          try {
            # Calculate new tags string
            if ([string]::IsNullOrWhiteSpace($existingTags)) {
              $newTags = $envTag
            } else {
              $newTags = "$existingTags; $envTag"
            }
            
            # Create replace payload
            $updatePayload = @(
              @{
                op = "replace"
                path = "/fields/System.Tags"
                value = $newTags
              }
            )
            
            $body = $updatePayload | ConvertTo-Json -Depth 3
            Write-Host "Replace Request Body: $body"
            
            $response = Invoke-RestMethod -Method Patch -Uri $url -Headers @{
              Authorization  = "Basic $basicAuth"
              "Content-Type" = "application/json-patch+json"
            } -Body $body
            
            Write-Host "✅ Successfully updated tags using 'replace' operation"
            Write-Host "   Work Item: $wiTitle"
            Write-Host "   New Tags: $newTags"
            $successCount++
            
          } catch {
            Write-Host "❌ Both 'add' and 'replace' operations failed"
            Write-Host "   Final Error: $($_.Exception.Message)"
            
            # Try to read the response for more details
            try {
              if ($_.Exception.Response) {
                $stream = $_.Exception.Response.GetResponseStream()
                $stream.Position = 0
                $reader = New-Object System.IO.StreamReader($stream)
                $responseBody = $reader.ReadToEnd()
                Write-Host "   Response Body: $responseBody"
              }
            } catch {
              Write-Host "   Could not read response body"
            }
            
            $failureCount++
          }
        }
      }
      
      Write-Host ""
      Write-Host "=========================================="
      Write-Host "Update Summary:"
      Write-Host "✅ Successfully updated: $successCount"
      Write-Host "❌ Failed: $failureCount"
      Write-Host "Total processed: $($ids.Count)"
      Write-Host "=========================================="
      
      if ($failureCount -gt 0) {
        Write-Host "##vso[task.logissue type=warning]Some work items failed to update"
      }
    displayName: 'Update Azure DevOps Work Item Tags'